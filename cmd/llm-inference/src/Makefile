# Makefile for Python proto code generation
# æ”¾ç½®åœ¨llm-inference/protoç›®å½•

# é…ç½®é¡¹
PROTO_DIR := .
PROTO_FILES := $(wildcard $(PROTO_DIR)/*.proto)
PY_PROTO_OUT := $(PROTO_DIR)
PROTOC := protoc
UV := uv

# æ£€æŸ¥protocæ˜¯å¦å®‰è£…
ifeq ($(shell command -v $(PROTOC) 2>/dev/null),)
$(error "protocç¼–è¯‘å™¨æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…: sudo apt-get install protobuf-compiler")
endif

# æ£€æŸ¥uvæ˜¯å¦å®‰è£…
ifeq ($(shell command -v $(UV) 2>/dev/null),)
$(error "uvåŒ…ç®¡ç†å™¨æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…: curl -LsSf https://astral.sh/uv/install.sh | sh")
endif

# é»˜è®¤ç›®æ ‡
all: generate

# æ£€æŸ¥Pythonä¾èµ–
check-deps:
	@echo "æ£€æŸ¥Pythonä¾èµ–..."
	@$(UV) add --quiet protobuf grpcio grpcio-tools || echo "ä¾èµ–å·²å®‰è£…"
	@echo "âœ… Pythonä¾èµ–æ£€æŸ¥å®Œæˆ"

# ç”ŸæˆPythonä»£ç 

generate: check-deps
	@echo "âœ… å¼€å§‹ç”ŸæˆPython protoä»£ç ..."
	@echo "   å¤„ç†ç›®å½•: $(PROTO_DIR)"
	@echo "   Protoæ–‡ä»¶: $(PROTO_FILES)"
	@set -e; \
	for proto in $(PROTO_FILES); do \
		dir_name=$$(basename $$proto .proto); \
# 		mkdir -p $(PY_PROTO_OUT)/$$dir_name; \
		echo "   â†’ å¤„ç† $$proto â†’ ç”Ÿæˆåˆ° $(PY_PROTO_OUT)"; \
		$(UV) run python -m grpc_tools.protoc \
			--python_out=$(PY_PROTO_OUT) \
			--grpc_python_out=$(PY_PROTO_OUT) \
			-I $(PROTO_DIR) \
			$$proto; \
		echo "   âœ… $$proto ç”Ÿæˆå®Œæˆ"; \
	done


# æ¸…ç†ç”Ÿæˆçš„ä»£ç 
clean:
	@echo "ğŸ§¹ æ¸…ç†ç”Ÿæˆçš„Pythonä»£ç ..."
	@find $(PY_PROTO_OUT) -name "*.py" -type f -not -name "__init__.py" -delete 2>/dev/null || true
	@echo "æ¸…ç†å®Œæˆ"

# å®‰è£…æ‰€æœ‰ä¾èµ–
install-deps:
	@echo "â¬ å®‰è£…Pythonä¾èµ–..."
	@$(UV) venv --system-site-packages || echo "è™šæ‹Ÿç¯å¢ƒå·²å­˜åœ¨"
	@$(UV) pip install protobuf grpcio grpcio-tools
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

.PHONY: generate clean install-deps all check-deps