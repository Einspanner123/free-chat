# Makefile for micro-service proto code generation
# æ”¾ç½®åœ¨é¡¹ç›®æ ¹ç›®å½•: /home/linkst/workplace/micro-service/Makefile

# é…ç½®é¡¹
PROTO_DIR := .
PROTO_FILES := $(wildcard $(PROTO_DIR)/*.proto)
GO_PROTO_OUT := $(PROTO_DIR)
PROTOC := protoc
GO_PLUGIN := protoc-gen-go
GRPC_PLUGIN := protoc-gen-go-grpc

# æ£€æŸ¥protocæ˜¯å¦å®‰è£…
ifeq ($(shell command -v $(PROTOC) 2>/dev/null),)
$(error "protocç¼–è¯‘å™¨æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…: sudo apt-get install protobuf-compiler")
endif

# æ£€æŸ¥Goæ’ä»¶
check-plugins:
	@echo "æ£€æŸ¥protocæ’ä»¶..."
	@which $(GO_PLUGIN) >/dev/null || (echo "éœ€è¦å®‰è£…protoc-gen-go..."; \
		go install google.golang.org/protobuf/cmd/protoc-gen-go@latest)
	@which $(GRPC_PLUGIN) >/dev/null || (echo "éœ€è¦å®‰è£…protoc-gen-go-grpc..."; \
		go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest)
# export PATH="$PATH:$(go env GOPATH)/bin"

# protoc --go_out=./	--go-grpc_out=./	./proto/summarizer.proto
# ç”ŸæˆGoä»£ç 
generate: check-plugins
	@echo "âœ… å¼€å§‹ç”Ÿæˆprotoä»£ç ..."
	@echo "   å¤„ç†ç›®å½•: $(PROTO_DIR)"
	@echo "   Protoæ–‡ä»¶: $(PROTO_FILES)"
	@set -e; \
	for proto in $(PROTO_FILES); do \
		dir_name=$$(basename $$proto .proto); \
		mkdir -p $(GO_PROTO_OUT)/$$dir_name; \
		echo "   â†’ å¤„ç† $$proto â†’ ç”Ÿæˆåˆ° $(GO_BASE_OUT)/$$dir_name"; \
		$(PROTOC) \
			--go_out=$(GO_PROTO_OUT)/$$dir_name \
			--go_opt=paths=source_relative \
			--go-grpc_out=$(GO_PROTO_OUT)/$$dir_name \
			--go-grpc_opt=paths=source_relative \
			-I $(PROTO_DIR) \
			$$proto; \
	done

# æ¸…ç†ç”Ÿæˆçš„ä»£ç 
clean:
	@echo "ğŸ§¹ æ¸…ç†ç”Ÿæˆçš„Goä»£ç ..."
	@for proto in $(PROTO_FILES); do \
		dir_name=$$(basename $$proto .proto); \
		rm -r $$dir_name; \
		echo "   â†’ $$dir_name is removed"; \
	done
# 	@rm -f $(GO_PROTO_OUT)/*.pb.go
	@echo "æ¸…ç†å®Œæˆ"

# å®‰è£…æ‰€æœ‰ä¾èµ–
install-deps:
	@echo "â¬ å®‰è£…protocä¾èµ–..."
	go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
	go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

# é»˜è®¤ç›®æ ‡
all: generate

.PHONY: generate clean install-deps all check-plugins